<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECMO Scenario Simulator & Quiz</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            /* Adorable background gradient */
            background: linear-gradient(to bottom right, #e0f7fa, #bbdefb); /* Soft blue gradient */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            padding: 1rem; /* Base padding for small screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* Main container styling */
        .container {
            background-color: #ffffff;
            padding: 1.5rem; /* Base padding for small screens */
            border-radius: 1.5rem; /* Base rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Base shadow */
            max-width: 950px; /* Max width for better content display */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Base space between sections */
            border: 1px solid #e0e0e0; /* Subtle border */
        }
        /* Responsive adjustments for container */
        @media (min-width: 640px) { /* sm breakpoint */
            body {
                padding: 1.5rem;
            }
            .container {
                padding: 2rem;
                border-radius: 1.75rem;
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
                gap: 1.75rem;
            }
        }
        @media (min-width: 768px) { /* md breakpoint */
            body {
                padding: 2rem;
            }
            .container {
                padding: 3rem;
                border-radius: 2rem;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
                gap: 2rem;
            }
        }

        /* Heading and intro text styling */
        h1 {
            color: #2c3e50;
            font-size: 1.8rem; /* Base font size for small screens */
            margin-bottom: 0.5rem;
        }
        .intro-text {
            color: #55606e;
            font-size: 1rem; /* Base font size for small screens */
            line-height: 1.5;
        }
        .disclaimer {
            font-size: 0.8rem; /* Base font size for small screens */
            color: #7f8c8d;
            margin-top: 0.3rem;
        }
        /* Responsive adjustments for text */
        @media (min-width: 640px) {
            h1 {
                font-size: 2.2rem;
            }
            .intro-text {
                font-size: 1.1rem;
                line-height: 1.6;
            }
            .disclaimer {
                font-size: 0.85rem;
                margin-top: 0.4rem;
            }
        }
        @media (min-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            .intro-text {
                font-size: 1.15rem;
                line-height: 1.7;
            }
            .disclaimer {
                font-size: 0.9rem;
                margin-top: 0.5rem;
            }
        }

        /* Developer info styling */
        .developer-info {
            font-size: 0.85rem; /* Base font size for small screens */
            color: #607d8b;
            text-align: center;
            margin-top: 1.5rem; /* Base margin */
            padding-top: 0.75rem; /* Base padding */
            border-top: 1px solid #e0e0e0;
        }
        @media (min-width: 640px) {
            .developer-info {
                font-size: 0.9rem;
                margin-top: 1.75rem;
                padding-top: 0.9rem;
            }
        }
        @media (min-width: 768px) {
            .developer-info {
                font-size: 0.95rem;
                margin-top: 2rem;
                padding-top: 1rem;
            }
        }


        /* Input group styling - now for gauges */
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            gap: 0.5rem; /* Base gap */
            text-align: center;
        }
        .input-group label {
            font-weight: 700;
            color: #34495e;
            font-size: 0.9rem; /* Base font size */
            margin-bottom: 0.3rem; /* Base margin */
        }
        @media (min-width: 640px) {
            .input-group label {
                font-size: 0.95rem;
                margin-bottom: 0.4rem;
            }
        }
        @media (min-width: 768px) {
            .input-group label {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
        }

        /* Gauge specific styles */
        .gauge-container {
            width: 100px; /* Smaller base width for mobile */
            height: 60px; /* Smaller base height for mobile */
            position: relative;
            margin-bottom: 0.3rem; /* Base margin */
        }
        @media (min-width: 640px) {
            .gauge-container {
                width: 110px;
                height: 70px;
                margin-bottom: 0.4rem;
            }
        }
        @media (min-width: 768px) {
            .gauge-container {
                width: 120px;
                height: 80px;
                margin-bottom: 0.5rem;
            }
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
            overflow: visible; /* Allow needle to extend */
        }
        .gauge-track {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 8;
            transition: stroke 0.3s ease-in-out;
        }
        .gauge-needle {
            fill: #34495e;
            transform-origin: 50% 100%; /* Pivot point at the bottom center */
            transition: transform 0.3s ease-in-out;
        }
        .gauge-value-text {
            font-size: 0.8rem; /* Smaller base font size for gauge text */
            font-weight: 600;
            fill: #34495e;
            text-anchor: middle;
            dominant-baseline: central;
        }
        @media (min-width: 640px) {
            .gauge-value-text {
                font-size: 0.85rem;
            }
        }
        @media (min-width: 768px) {
            .gauge-value-text {
                font-size: 0.9rem;
            }
        }

        /* Color mapping for qualitative states */
        .color-normal { stroke: #2ecc71; } /* Green */
        .color-increased { stroke: #e67e22; } /* Orange */
        .color-decreased { stroke: #f1c40f; } /* Yellow */
        .color-severely_decreased { stroke: #e74c3c; } /* Red */
        .color-zero { stroke: #95a5a6; } /* Gray */

        /* Results area styling */
        #results {
            background-color: #fcfdff;
            padding: 1.5rem; /* Base padding */
            border-radius: 1rem; /* Base rounded corners */
            border: 2px dashed #a7d9f7;
            min-height: 150px; /* Base min height */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            color: #34495e;
            font-size: 0.95rem; /* Base font size */
            line-height: 1.6;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
        }
        @media (min-width: 640px) {
            #results {
                padding: 1.75rem;
                border-radius: 1.25rem;
                min-height: 160px;
                font-size: 1rem;
                line-height: 1.65;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            }
        }
        @media (min-width: 768px) {
            #results {
                padding: 2rem;
                border-radius: 1.5rem;
                min-height: 180px;
                font-size: 1.05rem;
                line-height: 1.7;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            }
        }

        #results p {
            margin-bottom: 0.6rem; /* Base margin */
        }
        #results strong {
            color: #2980b9;
        }
        #results .scenario-name {
            font-size: 1.5rem; /* Base font size */
            font-weight: 800;
            color: #34495e;
            margin-bottom: 0.4rem;
            gap: 0.5rem; /* Base gap */
        }
        @media (min-width: 640px) {
            #results .scenario-name {
                font-size: 1.65rem;
                margin-bottom: 0.45rem;
                gap: 0.6rem;
            }
        }
        @media (min-width: 768px) {
            #results .scenario-name {
                font-size: 1.8rem;
                margin-bottom: 0.5rem;
                gap: 0.75rem;
            }
        }
        #results .scenario-graphic {
            font-size: 1.8rem; /* Base font size */
            line-height: 1;
        }
        @media (min-width: 640px) {
            #results .scenario-graphic {
                font-size: 2rem;
            }
        }
        @media (min-width: 768px) {
            #results .scenario-graphic {
                font-size: 2.2rem;
            }
        }
        #results .scenario-description {
            color: #55606e;
            margin-bottom: 0.8rem; /* Base margin */
        }
        #results .full-description {
            display: none;
        }
        #results .read-more-btn {
            background-color: #6a82fb;
            color: #ffffff;
            padding: 0.5rem 1rem; /* Base padding */
            border-radius: 0.6rem; /* Base rounded corners */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* Lighter shadow */
            border: none;
            margin-top: 0.4rem; /* Base margin */
            font-size: 0.9rem; /* Base font size */
        }
        @media (min-width: 640px) {
            #results .read-more-btn {
                padding: 0.55rem 1.1rem;
                border-radius: 0.7rem;
                box-shadow: 0 3px 9px rgba(0, 0, 0, 0.09);
                margin-top: 0.45rem;
                font-size: 0.95rem;
            }
        }
        @media (min-width: 768px) {
            #results .read-more-btn {
                padding: 0.6rem 1.2rem;
                border-radius: 0.75rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                margin-top: 0.5rem;
                font-size: 1rem;
            }
        }
        #results hr {
            border-color: #cfd8dc;
            margin: 1rem 0; /* Base margin */
        }
        @media (min-width: 640px) {
            #results hr {
                margin: 1.25rem 0;
            }
        }
        @media (min-width: 768px) {
            #results hr {
                margin: 1.5rem 0;
            }
        }

        /* Responsive grid for inputs */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); /* Adjusted minmax for smaller screens */
            gap: 1rem; /* Base gap */
        }
        @media (min-width: 640px) {
            .input-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 1.25rem;
            }
        }
        @media (min-width: 768px) {
            .input-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1.5rem;
            }
        }

        /* Flowchart specific styling */
        .flowchart-section {
            background-color: #e8f5e9;
            padding: 1rem; /* Base padding */
            border-radius: 0.6rem; /* Base rounded corners */
            border: 1px solid #c8e6c9;
            margin-top: 1rem; /* Base margin */
            font-size: 0.9rem; /* Base font size */
            line-height: 1.5;
            text-align: left;
        }
        @media (min-width: 640px) {
            .flowchart-section {
                padding: 1.1rem;
                border-radius: 0.7rem;
                margin-top: 1.25rem;
                font-size: 0.92rem;
                line-height: 1.55;
            }
        }
        @media (min-width: 768px) {
            .flowchart-section {
                padding: 1.2rem;
                border-radius: 0.75rem;
                margin-top: 1.5rem;
                font-size: 0.95rem;
                line-height: 1.6;
            }
        }
        .flowchart-section h4 {
            font-weight: 700;
            color: #388e3c;
            margin-bottom: 0.6rem; /* Base margin */
            font-size: 1rem; /* Base font size */
        }
        @media (min-width: 640px) {
            .flowchart-section h4 {
                margin-bottom: 0.7rem;
                font-size: 1.05rem;
            }
        }
        @media (min-width: 768px) {
            .flowchart-section h4 {
                margin-bottom: 0.8rem;
                font-size: 1.1rem;
            }
        }
        .flowchart-step {
            margin-bottom: 0.4rem; /* Base margin */
        }
        .flowchart-question {
            font-weight: 600;
            color: #424242;
        }
        .flowchart-answer {
            margin-left: 1rem; /* Base margin */
            position: relative;
        }
        .flowchart-answer::before {
            content: '↳'; /* Arrow symbol */
            position: absolute;
            left: -0.8rem; /* Adjusted position */
            color: #607d8b;
        }
        .flowchart-result {
            font-weight: 700;
            color: #1976d2;
        }

        /* Style for the actual dropdowns when enabled for custom input */
        .param-dropdown {
            padding: 0.6rem 0.8rem; /* Base padding */
            border: 1px solid #cbd5e0;
            border-radius: 0.6rem; /* Base rounded corners */
            font-size: 0.9rem; /* Base font size */
            color: #2d3748;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #ffffff;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234a5568%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.2-16.2%208.1-3.9%204.9-4.7%2011.4-2.1%2017.3l139.3%20139.3c3.9%203.9%209.2%206.2%2014.7%206.2s10.8-2.3%2014.7-6.2l139.3-139.3c5.4-5.9%204.6-12.4.7-17.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.6rem center; /* Adjusted position */
            background-size: 0.7em auto; /* Adjusted size */
            width: 100%;
        }
        @media (min-width: 640px) {
            .param-dropdown {
                padding: 0.7rem 0.9rem;
                border-radius: 0.7rem;
                font-size: 0.95rem;
                background-position: right 0.7rem center;
                background-size: 0.75em auto;
            }
        }
        @media (min-width: 768px) {
            .param-dropdown {
                padding: 0.75rem 1rem;
                border-radius: 0.75rem;
                font-size: 1rem;
                background-position: right 0.75rem center;
                background-size: 0.8em auto;
            }
        }
        .param-dropdown:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .param-dropdown:disabled {
            background-color: #eceff1;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Quiz specific styles */
        #quiz-section {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem; /* Base padding */
            background-color: #f8fcfd;
            border-radius: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        @media (min-width: 640px) {
            #quiz-section {
                padding: 1.75rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-section {
                padding: 2rem;
            }
        }

        #quiz-question-area {
            background-color: #ffffff;
            padding: 1rem; /* Base padding */
            border-radius: 0.75rem; /* Base rounded corners */
            border: 1px solid #e0e0e0;
        }
        @media (min-width: 640px) {
            #quiz-question-area {
                padding: 1.25rem;
                border-radius: 0.85rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-question-area {
                padding: 1.5rem;
                border-radius: 1rem;
            }
        }
        #quiz-question-area h3 {
            font-size: 1.2rem; /* Base font size */
            font-weight: 700;
            color: #34495e;
            margin-bottom: 0.8rem; /* Base margin */
        }
        @media (min-width: 640px) {
            #quiz-question-area h3 {
                font-size: 1.35rem;
                margin-bottom: 0.9rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-question-area h3 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
        }
        #quiz-vignette {
            font-size: 0.95rem; /* Base font size */
            line-height: 1.5;
            margin-bottom: 1rem; /* Base margin */
            color: #55606e;
        }
        @media (min-width: 640px) {
            #quiz-vignette {
                font-size: 1.05rem;
                line-height: 1.55;
                margin-bottom: 1.25rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-vignette {
                font-size: 1.1rem;
                line-height: 1.6;
                margin-bottom: 1.5rem;
            }
        }
        #quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.6rem; /* Base gap */
        }
        @media (min-width: 640px) {
            #quiz-options {
                gap: 0.7rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-options {
                gap: 0.75rem;
            }
        }
        .quiz-option-btn {
            background-color: #e3f2fd;
            color: #2980b9;
            padding: 0.6rem 1rem; /* Base padding */
            border-radius: 0.6rem; /* Base rounded corners */
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: 1px solid #bbdefb;
            font-size: 0.9rem; /* Base font size */
        }
        @media (min-width: 640px) {
            .quiz-option-btn {
                padding: 0.7rem 1.1rem;
                border-radius: 0.7rem;
                font-size: 0.95rem;
            }
        }
        @media (min-width: 768px) {
            .quiz-option-btn {
                padding: 0.8rem 1.2rem;
                border-radius: 0.75rem;
                font-size: 1rem;
            }
        }
        .quiz-option-btn:hover:not(.selected):not(.correct):not(.incorrect) {
            background-color: #bbdefb;
            transform: translateY(-1px);
        }
        .quiz-option-btn.selected {
            border-color: #6a82fb;
            box-shadow: 0 0 0 2px rgba(106, 130, 251, 0.4);
        }
        .quiz-option-btn.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
            pointer-events: none;
        }
        .quiz-option-btn.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            pointer-events: none;
        }
        #quiz-feedback {
            margin-top: 0.8rem; /* Base margin */
            padding: 0.7rem; /* Base padding */
            border-radius: 0.4rem; /* Base rounded corners */
            font-size: 0.9rem; /* Base font size */
            line-height: 1.4;
            display: none;
        }
        @media (min-width: 640px) {
            #quiz-feedback {
                margin-top: 0.9rem;
                padding: 0.75rem;
                border-radius: 0.45rem;
                font-size: 0.95rem;
                line-height: 1.45;
            }
        }
        @media (min-width: 768px) {
            #quiz-feedback {
                margin-top: 1rem;
                padding: 0.8rem;
                border-radius: 0.5rem;
                font-size: 1rem;
                line-height: 1.5;
            }
        }
        #quiz-feedback.correct-feedback {
            background-color: #e6ffe6;
            color: #1a7a1a;
            border: 1px solid #28a745;
        }
        #quiz-feedback.incorrect-feedback {
            background-color: #ffe6e6;
            color: #a71a1a;
            border: 1px solid #dc3545;
        }
        #quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem; /* Base margin */
        }
        @media (min-width: 640px) {
            #quiz-navigation {
                margin-top: 1.25rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-navigation {
                margin-top: 1.5rem;
            }
        }
        .quiz-nav-btn {
            background-color: #4299e1;
            color: #ffffff;
            padding: 0.6rem 1.2rem; /* Base padding */
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-size: 0.9rem; /* Base font size */
        }
        @media (min-width: 640px) {
            .quiz-nav-btn {
                padding: 0.65rem 1.3rem;
                font-size: 0.95rem;
            }
        }
        @media (min-width: 768px) {
            .quiz-nav-btn {
                padding: 0.7rem 1.4rem;
                font-size: 1rem;
            }
        }
        .quiz-nav-btn:hover {
            background-color: #3182ce;
        }
        .quiz-nav-btn:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        #quiz-score {
            text-align: center;
            font-size: 1rem; /* Base font size */
            font-weight: 700;
            color: #2c3e50;
            margin-top: 0.5rem; /* Base margin */
        }
        @media (min-width: 640px) {
            #quiz-score {
                font-size: 1.1rem;
                margin-top: 0.75rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-score {
                font-size: 1.2rem;
                margin-top: 1rem;
            }
        }
        #quiz-final-score {
            text-align: center;
            font-size: 1.5rem; /* Base font size */
            font-weight: 800;
            color: #28a745;
            margin-top: 1rem; /* Base margin */
        }
        @media (min-width: 640px) {
            #quiz-final-score {
                font-size: 1.65rem;
                margin-top: 1.25rem;
            }
        }
        @media (min-width: 768px) {
            #quiz-final-score {
                font-size: 1.8rem;
                margin-top: 1.5rem;
            }
        }
        #quiz-restart-btn {
            background-color: #2ecc71;
            margin-top: 1rem;
        }
        #quiz-restart-btn:hover {
            background-color: #27ae60;
        }
        #back-to-simulator-btn {
            background-color: #607d8b;
            color: #ffffff;
            padding: 0.7rem 1.4rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1.5rem;
            align-self: center;
        }
        #back-to-simulator-btn:hover {
            background-color: #455a64;
        }
    </style>
</head>
<body>
    <div class="container" id="main-simulator-section">
        <h1 class="text-center">ECMO Scenario Simulator</h1>
        <p class="intro-text text-center">
            Select a predefined scenario to see its characteristic parameter trends and potential complications.
        </p>
        <p class="disclaimer text-center">
            (All values are illustrative and for educational purposes only. Consult medical professionals for actual patient care.)
        </p>

        <div class="input-group mb-6 flex-row justify-between items-center">
            <label for="scenarioSelect" class="mb-0">Select a Predefined Scenario:</label>
            <select id="scenarioSelect" class="param-dropdown w-2/3">
                <option value="normal_operation">Normal Operation (Baseline)</option>
                <option value="membrane_clot">Membrane Lung Clot / Oxygenator Failure</option>
                <option value="hypovolemia">Hypovolemia / Access Insufficiency</option>
                <option value="access_kink">Access Cannula Kink</option>
                <option value="return_kink">Return Cannula Kink / Distal Obstruction</option>
                <option value="air_in_circuit">Air in Access Circuit</option>
                <option value="impending_pump_failure">Impending Pump Failure</option>
                <option value="circuit_rupture">Circuit Rupture / Disconnection</option>
                <option value="access_cannula_clot">Clot in Access Cannula</option>
                <option value="return_cannula_clot">Clot in Return Cannula</option>
                <option value="power_failure">Power Failure</option>
                <option value="custom">Custom Input</option>
            </select>
            <button id="start-quiz-btn" class="quiz-nav-btn ml-4">Start Quiz</button>
        </div>

        <div class="input-grid">
            <div class="input-group">
                <label for="p1-select">P1 (Pre-pump Pressure)</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="p1-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="p1-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="p1-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="p1-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="p1-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="increased">Increased</option>
                    <option value="decreased">Decreased</option>
                    <option value="severely_decreased">Severely Decreased</option>
                </select>
            </div>
            <div class="input-group">
                <label for="p2-select">P2 (Post-pump Pressure)</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="p2-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="p2-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="p2-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="p2-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="p2-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="increased">Increased</option>
                    <option value="decreased">Decreased</option>
                </select>
            </div>
            <div class="input-group">
                <label for="p3-select">P3 (Post-oxygenator Pressure)</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="p3-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="p3-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="p3-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="p3-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="p3-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="increased">Increased</option>
                    <option value="decreased">Decreased</option>
                </select>
            </div>
            <div class="input-group">
                <label for="deltaP-select">Delta Pressure (P2-P3)</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="deltaP-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="deltaP-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="deltaP-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="deltaP-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="deltaP-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="increased">Increased</option>
                    <option value="decreased">Decreased</option>
                </select>
            </div>
            <div class="input-group">
                <label for="flow-select">Flow</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="flow-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="flow-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="flow-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="flow-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="flow-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="decreased">Decreased</option>
                    <option value="severely_decreased">Severely Decreased</option>
                    <option value="zero">Zero</option>
                </select>
            </div>
            <div class="input-group">
                <label for="rpm-select">RPM</label>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 100 60">
                        <path id="rpm-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                        <path id="rpm-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                        <polygon id="rpm-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                        <text id="rpm-value" class="gauge-value-text" x="50" y="50"></text>
                    </svg>
                </div>
                <select id="rpm-select" class="param-dropdown" disabled>
                    <option value="normal">Normal</option>
                    <option value="increased">Increased</option>
                    <option value="decreased">Decreased</option>
                    <option value="zero">Zero</option>
                </select>
            </div>
        </div>

        <div id="results" class="mt-8">
            <p>Select a scenario from the dropdown above to see its characteristic trends and potential complications.</p>
        </div>

        <p class="developer-info">Developed by: Dr. Raghavendra Deshpande, Consultant Manipal Hospitals Sarjapur Road, Bengaluru</p>
    </div>

    <!-- Quiz Section -->
    <div class="container" id="quiz-section" style="display: none;">
        <h1 class="text-center">ECMO Quiz</h1>
        <p class="intro-text text-center">
            Test your knowledge of ECMO complications! Read the clinical vignette and observe the parameter trends to select the most likely complication.
        </p>
        <p class="disclaimer text-center">
            (Each question is worth 5 marks. Total 50 marks.)
        </p>

        <div id="quiz-question-area">
            <h3 id="question-counter">Question 1 of 10</h3>
            <p id="quiz-vignette"></p>
            <div class="input-grid mb-4">
                <div class="input-group">
                    <label>P1 (Pre-pump Pressure)</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-p1-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-p1-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-p1-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-p1-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
                <div class="input-group">
                    <label>P2 (Post-pump Pressure)</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-p2-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-p2-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-p2-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-p2-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
                <div class="input-group">
                    <label>P3 (Post-oxygenator Pressure)</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-p3-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-p3-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-p3-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-p3-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
                <div class="input-group">
                    <label>Delta Pressure (P2-P3)</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-deltaP-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-deltaP-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-deltaP-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-deltaP-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
                <div class="input-group">
                    <label>Flow</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-flow-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-flow-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-flow-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-flow-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
                <div class="input-group">
                    <label>RPM</label>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 100 60">
                            <path id="quiz-rpm-track" class="gauge-track" d="M10 50 A 40 40 0 0 1 90 50" />
                            <path id="quiz-rpm-fill" class="gauge-fill" d="M10 50 A 40 40 0 0 1 90 50" />
                            <polygon id="quiz-rpm-needle" class="gauge-needle" points="48,50 52,50 50,15" />
                            <text id="quiz-rpm-value" class="gauge-value-text" x="50" y="50"></text>
                        </svg>
                    </div>
                </div>
            </div>
            <div id="quiz-options">
                <!-- Options will be dynamically loaded here -->
            </div>
            <div id="quiz-feedback" class="mt-4"></div>
        </div>

        <div id="quiz-navigation" class="flex justify-between items-center">
            <button id="quiz-prev-btn" class="quiz-nav-btn" disabled>Previous</button>
            <div id="quiz-score">Score: 0 / 50</div>
            <button id="quiz-next-btn" class="quiz-nav-btn">Next</button>
        </div>
        <button id="back-to-simulator-btn">Back to Simulator</button>
        <p class="developer-info">Developed by: Dr. Raghavendra Deshpande, Consultant Manipal Hospitals Sarjapur Road, Bengaluru</p>
    </div>

    <script>
        // --- Common Elements & Functions (Simulator & Quiz) ---
        const mainSimulatorSection = document.getElementById('main-simulator-section');
        const quizSection = document.getElementById('quiz-section');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const backToSimulatorBtn = document.getElementById('back-to-simulator-btn');

        const scenarioSelect = document.getElementById('scenarioSelect');
        const resultsDiv = document.getElementById('results');

        // References to gauge elements AND their corresponding select dropdowns (for custom mode)
        const gauges = {
            p1: { needle: document.getElementById('p1-needle'), fill: document.getElementById('p1-fill'), valueText: document.getElementById('p1-value'), select: document.getElementById('p1-select') },
            p2: { needle: document.getElementById('p2-needle'), fill: document.getElementById('p2-fill'), valueText: document.getElementById('p2-value'), select: document.getElementById('p2-select') },
            p3: { needle: document.getElementById('p3-needle'), fill: document.getElementById('p3-fill'), valueText: document.getElementById('p3-value'), select: document.getElementById('p3-select') },
            deltaP: { needle: document.getElementById('deltaP-needle'), fill: document.getElementById('deltaP-fill'), valueText: document.getElementById('deltaP-value'), select: document.getElementById('deltaP-select') },
            flow: { needle: document.getElementById('flow-needle'), fill: document.getElementById('flow-fill'), valueText: document.getElementById('flow-value'), select: document.getElementById('flow-select') },
            rpm: { needle: document.getElementById('rpm-needle'), fill: document.getElementById('rpm-fill'), valueText: document.getElementById('rpm-value'), select: document.getElementById('rpm-select') },
        };

        // References to quiz gauge elements
        const quizGauges = {
            p1: { needle: document.getElementById('quiz-p1-needle'), fill: document.getElementById('quiz-p1-fill'), valueText: document.getElementById('quiz-p1-value') },
            p2: { needle: document.getElementById('quiz-p2-needle'), fill: document.getElementById('quiz-p2-fill'), valueText: document.getElementById('quiz-p2-value') },
            p3: { needle: document.getElementById('quiz-p3-needle'), fill: document.getElementById('quiz-p3-fill'), valueText: document.getElementById('quiz-p3-value') },
            deltaP: { needle: document.getElementById('quiz-deltaP-needle'), fill: document.getElementById('quiz-deltaP-fill'), valueText: document.getElementById('quiz-deltaP-value') },
            flow: { needle: document.getElementById('quiz-flow-needle'), fill: document.getElementById('quiz-flow-fill'), valueText: document.getElementById('quiz-flow-value') },
            rpm: { needle: document.getElementById('quiz-rpm-needle'), fill: document.getElementById('quiz-rpm-fill'), valueText: document.getElementById('quiz-rpm-value') },
        };

        // Define predefined scenarios with full and short descriptions, qualitative parameters, AND diagnostic algorithms
        const scenarios = {
            "custom": {
                name: "Custom Input",
                shortDescription: "Manually set the trends for all parameters to explore various combinations.",
                fullDescription: "This mode allows you to freely adjust the qualitative trends for P1, P2, P3, Delta P, Flow, and RPM. It's ideal for testing specific hypothetical scenarios or for understanding the individual impact of each parameter change. Remember that some combinations may represent highly critical or impossible circuit states.",
                graphic: "📊",
                params: { p1: 'normal', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'normal', rpm: 'normal' },
                algorithm: null // No specific algorithm for custom input
            },
            "normal_operation": {
                name: "Normal Operation (Baseline)",
                shortDescription: "Represents a healthy, stable ECMO circuit with all parameters within expected normal ranges.",
                fullDescription: "In a normal ECMO operation, the pump efficiently draws blood (normal P1), pushes it through the oxygenator (normal P2 and P3, normal Delta P), and returns it to the patient at the desired flow rate with stable RPM. This indicates optimal physiological support and circuit integrity.",
                graphic: "✅",
                params: { p1: 'normal', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'normal', rpm: 'normal' },
                algorithm: null // No specific algorithm for normal operation
            },
            "membrane_clot": {
                name: "Membrane Lung Clot / Oxygenator Failure",
                shortDescription: "A clot in the oxygenator increases resistance, leading to increased P2, decreased P3, high Delta P, and decreased flow.",
                fullDescription: "When a clot forms within the oxygenator, it obstructs blood flow, increasing the pressure required to push blood into it (increased P2). Simultaneously, the pressure beyond the oxygenator drops (decreased P3) due to the increased resistance. This creates a significant increase in the pressure difference across the oxygenator (Delta P). Despite the pump maintaining its RPM, the overall blood flow through the circuit decreases.",
                graphic: "🛑",
                params: { p1: 'normal', p2: 'increased', p3: 'decreased', deltaP: 'increased', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is Delta Pressure (P2-P3) HIGH?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → This might not be an oxygenator clot.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Oxygenator Clotting/Failure.</strong>
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other pump issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "hypovolemia": {
                name: "Hypovolemia / Access Insufficiency",
                shortDescription: "Low blood volume leads to severely decreased P1 and decreased flow, despite normal RPM.",
                fullDescription: "In hypovolemia, the patient lacks sufficient circulating blood volume for the ECMO pump to draw. The pump 'sucks dry' or 'cavitates', causing the pre-pump pressure (P1) to become severely negative. This 'chattering' can damage blood components. Despite the pump running at its set RPM, the actual blood flow through the circuit significantly decreases because there's not enough blood to fill the circuit.",
                graphic: "💧",
                params: { p1: 'severely_decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P1 VERY LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → This might not be hypovolemia.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Hypovolemia / Access Insufficiency.</strong>
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other pump issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "access_kink": {
                name: "Access Cannula Kink",
                shortDescription: "A kink in the access cannula causes severely decreased P1 and decreased flow at normal RPM.",
                fullDescription: "A physical kink or obstruction in the access cannula restricts blood flow from the patient to the ECMO circuit. This creates a high vacuum effect before the pump, causing P1 to drop severely (become very negative). Similar to hypovolemia, the pump struggles to pull blood, leading to a significant reduction in overall circuit flow, even if the pump's RPM remains constant.",
                graphic: "➰",
                params: { p1: 'severely_decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P1 VERY LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → This might not be a kink.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Access Cannula Kink.</strong> (Visually check the cannula for bends)
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other pump issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "return_kink": {
                name: "Return Cannula Kink / Distal Obstruction",
                shortDescription: "An obstruction in the return limb causes increased P3, increased P2, and decreased flow at normal RPM, with normal Delta P.",
                fullDescription: "An obstruction in the return cannula or the patient's vasculature (e.g., severe vasoconstriction, cannula malposition) impedes the return of oxygenated blood to the patient. This causes pressure to build up in the return limb (increased P3). The increased resistance can also lead to an increase in P2 as the entire circuit experiences increased back pressure. If P2 and P3 increase proportionally, the Delta P across the oxygenator may remain relatively normal. Overall circuit flow will decrease even if the pump's RPM is unchanged.",
                graphic: "↩️",
                params: { p1: 'normal', p2: 'increased', p3: 'increased', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P3 HIGH?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is P2 HIGH AND Delta P NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings. (If Delta P is HIGH, consider oxygenator issues)
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is Flow LOW AND RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Return Cannula Kink / Distal Obstruction.</strong> (Visually check cannula, assess patient)
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings.
                            </div>
                        </div>
                    </div>
                `
            },
            "air_in_circuit": {
                name: "Air in Access Circuit",
                shortDescription: "Air causes P1 to severely decrease (chattering), leading to critically low and erratic flow.",
                fullDescription: "Air entering the access limb of the ECMO circuit causes the pump to cavitate or 'chatter'. This results in wildly fluctuating and often severely negative P1 readings. The presence of air significantly reduces the pump's efficiency, leading to a critically low, unstable, and often erratic blood flow, even with the pump running at normal RPM.",
                graphic: "💨",
                params: { p1: 'severely_decreased', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'severely_decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P1 VERY LOW (and possibly fluctuating)?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → This might not be air in the circuit.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow CRITICALLY LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Air in Access Circuit.</strong> (Visually inspect circuit for air bubbles)
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other pump issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "impending_pump_failure": {
                name: "Impending Pump Failure",
                shortDescription: "Flow decreases despite normal RPM, with P2 and P3 potentially decreasing as pump efficiency drops.",
                fullDescription: "If the ECMO pump itself begins to fail (e.g., motor issues, bearing wear), its ability to generate pressure and flow diminishes. This is characterized by a decrease in overall circuit flow despite the pump maintaining its set RPM. P2 and P3 may also decrease as the pump can no longer effectively push blood through the circuit. This scenario requires immediate attention and potential pump change-out.",
                graphic: "⚙️",
                params: { p1: 'normal', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is Flow LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Are P2 and P3 LOW AND Delta P NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Impending Pump Failure.</strong> (Prepare for pump change)
                            </div>
                            <div class="flowchart-answer">
                                No → Consider circuit rupture or other issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "circuit_rupture": {
                name: "Circuit Rupture / Disconnection",
                shortDescription: "Catastrophic event: P2 & P3 decrease rapidly, flow drops to zero, and RPM remains high.",
                fullDescription: "A circuit rupture or accidental disconnection is a critical emergency. Blood rapidly leaks from the circuit, causing a sudden and drastic drop in P2 and P3 (often to ambient pressure). The flow will immediately drop to zero, while the pump, no longer encountering resistance, may continue to spin at its set RPM, potentially leading to cavitation or air entrainment. This requires immediate clamping and intervention.",
                graphic: "⚠️",
                params: { p1: 'normal', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'zero', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is Flow ZERO?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider power failure if RPM is zero.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Are P2 and P3 LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Circuit Rupture / Disconnection.</strong> (IMMEDIATE CLAMPING & INTERVENTION)
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings.
                            </div>
                        </div>
                    </div>
                `
            },
            "access_cannula_clot": {
                name: "Clot in Access Cannula",
                shortDescription: "A clot in the access cannula causes severely decreased P1 and significantly decreased flow.",
                fullDescription: "A thrombus (clot) forming directly within the access cannula creates a significant obstruction, severely limiting the amount of blood that can be drawn into the ECMO circuit. This leads to a marked drop in P1 (more negative pressure) and a significant reduction in overall circuit flow, even with the pump running at its normal RPM. This can be a precursor to more widespread circuit clotting.",
                graphic: "🩸",
                params: { p1: 'severely_decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P1 VERY LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow LOW?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Are P2, P3, and Delta P NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Clot in Access Cannula.</strong> (Visually check cannula, assess patient volume)
                            </div>
                            <div class="flowchart-answer">
                                No → Consider hypovolemia or other access issues.
                            </div>
                        </div>
                    </div>
                `
            },
            "return_cannula_clot": {
                name: "Clot in Return Cannula",
                shortDescription: "A clot in the return cannula causes increased P3, increased P2, and decreased flow.",
                fullDescription: "A thrombus (clot) in the return cannula obstructs the flow of oxygenated blood back to the patient. This causes pressure to build up significantly in the return limb (increased P3). The increased resistance propagates backward through the circuit, often leading to an increase in P2 as well. Despite the pump maintaining its RPM, the overall circuit flow will decrease due to the downstream obstruction.",
                graphic: "🩸",
                params: { p1: 'normal', p2: 'increased', p3: 'increased', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is P3 HIGH?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is P2 HIGH AND Delta P NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings. (If Delta P is HIGH, consider oxygenator issues)
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Is Flow LOW AND RPM NORMAL?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Clot in Return Cannula.</strong> (Visually check cannula, assess patient)
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck readings.
                            </div>
                        </div>
                    </div>
                `
            },
            "power_failure": {
                name: "Power Failure",
                shortDescription: "Sudden loss of power stops the pump, leading to zero RPM, zero flow, decreased P2/P3, and potentially increased P1.",
                fullDescription: "A power failure to the ECMO pump results in an immediate cessation of pump activity. This is characterized by RPM dropping to zero and flow stopping (zero flow). Without the pump actively driving blood, the pressures within the circuit (P2 and P3) will rapidly decrease as the system equalizes. P1 may increase as the 'pull' from the pump disappears and venous pressure may passively fill the access line.",
                graphic: "🔌",
                params: { p1: 'increased', p2: 'decreased', p3: 'decreased', deltaP: 'decreased', flow: 'zero', rpm: 'zero' },
                algorithm: `
                    <div class="flowchart-section">
                        <h4>Diagnostic Algorithm (Flowchart)</h4>
                        <div class="flowchart-step">
                            <span class="flowchart-question">1. Is RPM ZERO?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 2.
                            </div>
                            <div class="flowchart-answer">
                                No → Consider other complications.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">2. Is Flow ZERO?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → Go to step 3.
                            </div>
                            <div class="flowchart-answer">
                                No → Recheck all readings.
                            </div>
                        </div>
                        <div class="flowchart-step">
                            <span class="flowchart-question">3. Are P2 and P3 LOW, AND P1 HIGH?</span>
                            <div class="flowchart-answer">
                                <span class="flowchart-result">Yes</span> → <strong>This likely means: Power Failure.</strong> (Check power source, hand crank if needed)
                            </div>
                            <div class="flowchart-answer">
                                No → Consider pump malfunction or other causes of pump stop.
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // --- Quiz Specific Variables & Functions ---
        const quizQuestionArea = document.getElementById('quiz-question-area');
        const questionCounter = document.getElementById('question-counter');
        const quizVignette = document.getElementById('quiz-vignette');
        const quizOptionsDiv = document.getElementById('quiz-options');
        const quizFeedbackDiv = document.getElementById('quiz-feedback');
        const quizScoreDisplay = document.getElementById('quiz-score');
        const quizPrevBtn = document.getElementById('quiz-prev-btn');
        const quizNextBtn = document.getElementById('quiz-next-btn');

        let currentQuizQuestionIndex = 0;
        let quizScore = 0;
        let userQuizAnswers = []; // To store selected answer index per question

        // Define quiz questions (10 scenarios, 5 marks each)
        const quizQuestions = [
            {
                vignette: "A 45-year-old patient on VV ECMO suddenly develops a **high P2** alarm and a **low P3** alarm. The circuit flow has significantly **decreased**, but the **RPM remains normal**. There are no visible kinks in the cannulas.",
                params: { p1: 'normal', p2: 'increased', p3: 'decreased', deltaP: 'increased', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Hypovolemia",
                    "Membrane Lung Clot / Oxygenator Failure",
                    "Return Cannula Kink",
                    "Power Failure"
                ],
                correctAnswerIndex: 1, // Index of "Membrane Lung Clot / Oxygenator Failure"
                explanation: "This pattern (increased P2, decreased P3, high Delta P, decreased flow at normal RPM) is characteristic of increased resistance across the oxygenator, most commonly due to a clot or oxygenator failure."
            },
            {
                vignette: "A 60-year-old patient on VA ECMO suddenly shows a **severely decreased P1** with frequent 'chattering' of the access line. The **flow has dropped** significantly, but the **RPM is unchanged**. The patient appears pale with poor peripheral perfusion.",
                params: { p1: 'severely_decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Access Cannula Kink",
                    "Membrane Lung Clot",
                    "Impending Pump Failure",
                    "Circuit Rupture"
                ],
                correctAnswerIndex: 0, // Index of "Access Cannula Kink" (or Hypovolemia)
                explanation: "A severely decreased P1 with chattering and decreased flow at normal RPM strongly suggests an issue with venous return to the pump. This could be due to hypovolemia or an access cannula kink. Given no other changes, a kink is a strong possibility."
            },
            {
                vignette: "During a routine ECMO round, you notice the **RPM is zero** and the **flow is also zero**. P2 and P3 are both **decreased**, and P1 is **increased**. The bedside monitor shows the ECMO machine is off.",
                params: { p1: 'increased', p2: 'decreased', p3: 'decreased', deltaP: 'decreased', flow: 'zero', rpm: 'zero' },
                options: [
                    "Air in Circuit",
                    "Circuit Rupture",
                    "Power Failure",
                    "Return Cannula Clot"
                ],
                correctAnswerIndex: 2, // Index of "Power Failure"
                explanation: "Zero RPM and zero flow, coupled with decreased P2/P3 and an increased P1, are classic signs of a power failure or deliberate shutdown of the ECMO pump. The increased P1 occurs because the pump is no longer pulling blood from the patient."
            },
            {
                vignette: "A patient on ECMO has stable RPM, but the **flow has gradually decreased** over the last hour. Both **P2 and P3 are slightly decreased**, and the **Delta P remains normal**. There are no visible clots or kinks.",
                params: { p1: 'normal', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Hypovolemia",
                    "Membrane Lung Clot",
                    "Impending Pump Failure",
                    "Access Cannula Clot"
                ],
                correctAnswerIndex: 2, // Index of "Impending Pump Failure"
                explanation: "A gradual decrease in flow despite normal RPM, with proportionally decreased P2 and P3 (normal Delta P), suggests that the pump itself is becoming less efficient, indicating impending pump failure."
            },
            {
                vignette: "You hear a loud alarm and see the ECMO circuit is disconnected from the patient's return cannula. The **flow has dropped to zero**, **P2 and P3 are severely decreased**, but the **pump is still running at normal RPM**.",
                params: { p1: 'normal', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'zero', rpm: 'normal' },
                options: [
                    "Power Failure",
                    "Air in Circuit",
                    "Circuit Rupture / Disconnection",
                    "Oxygenator Clot"
                ],
                correctAnswerIndex: 2, // Index of "Circuit Rupture / Disconnection"
                explanation: "Zero flow with a running pump (normal RPM) and drastically decreased P2/P3 points to a loss of circuit integrity, such as a rupture or disconnection, where the blood volume is no longer contained within the circuit."
            },
            {
                vignette: "The patient's venous access site appears swollen. The ECMO monitor shows a **severely decreased P1** and a **decreased flow**. P2, P3, and Delta P remain normal, and the RPM is unchanged.",
                params: { p1: 'severely_decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Return Cannula Clot",
                    "Access Cannula Clot",
                    "Impending Pump Failure",
                    "Air in Circuit"
                ],
                correctAnswerIndex: 1, // Index of "Access Cannula Clot"
                explanation: "A severely decreased P1 and decreased flow, with otherwise normal circuit pressures, are classic signs of an obstruction in the access cannula, often due to a clot or malposition."
            },
            {
                vignette: "A patient on ECMO is agitated. You notice the **return cannula is bent** at an acute angle. The monitor shows **P3 is increased**, **P2 is also increased**, and **Delta P is normal**. Flow is decreased, but RPM is normal.",
                params: { p1: 'normal', p2: 'increased', p3: 'increased', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Membrane Lung Clot",
                    "Access Cannula Kink",
                    "Return Cannula Kink / Distal Obstruction",
                    "Hypovolemia"
                ],
                correctAnswerIndex: 2, // Index of "Return Cannula Kink / Distal Obstruction"
                explanation: "An increased P3 (and proportionally increased P2, keeping Delta P normal) with decreased flow at normal RPM is highly indicative of an obstruction in the return limb, such as a kinked cannula or severe patient vasoconstriction."
            },
            {
                vignette: "You observe intermittent 'chattering' in the access line and foam in the reservoir. P1 is **severely decreased** and fluctuating. Flow is **critically low** and erratic, while RPM remains normal. P2 and P3 are both **decreased**.",
                params: { p1: 'severely_decreased', p2: 'decreased', p3: 'decreased', deltaP: 'normal', flow: 'severely_decreased', rpm: 'normal' },
                options: [
                    "Power Failure",
                    "Air in Access Circuit",
                    "Circuit Rupture",
                    "Impending Pump Failure"
                ],
                correctAnswerIndex: 1, // Index of "Air in Access Circuit"
                explanation: "Severely decreased and fluctuating P1, critically low flow, and visible foam/chattering are hallmark signs of air entrainment in the access circuit. This is a critical situation requiring immediate intervention."
            },
            {
                vignette: "A patient on ECMO suddenly becomes hypotensive. The ECMO flow has **decreased**, and P1 is now **decreased** (more negative than before). P2, P3, and Delta P are all normal. RPM is unchanged.",
                params: { p1: 'decreased', p2: 'normal', p3: 'normal', deltaP: 'normal', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Hypovolemia",
                    "Membrane Lung Clot",
                    "Return Cannula Clot",
                    "Power Failure"
                ],
                correctAnswerIndex: 0, // Index of "Hypovolemia"
                explanation: "A decreased P1 and decreased flow at normal RPM, with otherwise normal circuit pressures, strongly suggests that the patient is hypovolemic and the pump is struggling to draw enough blood."
            },
            {
                vignette: "The ECMO circuit has been running smoothly, but suddenly you notice a **large clot** visible in the oxygenator membrane. The monitor shows **P2 is increased**, **P3 is decreased**, and the **Delta P is significantly increased**. Flow is **decreased** despite normal RPM.",
                params: { p1: 'normal', p2: 'increased', p3: 'decreased', deltaP: 'increased', flow: 'decreased', rpm: 'normal' },
                options: [
                    "Access Cannula Kink",
                    "Return Cannula Kink",
                    "Membrane Lung Clot / Oxygenator Failure",
                    "Impending Pump Failure"
                ],
                correctAnswerIndex: 2, // Index of "Membrane Lung Clot / Oxygenator Failure"
                explanation: "The presence of a visible clot in the oxygenator, combined with increased P2, decreased P3, a high Delta P, and decreased flow at normal RPM, unequivocally points to a membrane lung clot or oxygenator failure."
            }
        ];

        /**
         * Updates a single gauge's needle position, fill color, and text value.
         * @param {Object} gauge - The gauge object (needle, fill, valueText SVG elements).
         * @param {string} trend - The qualitative trend ('normal', 'increased', 'decreased', 'severely_decreased', 'zero').
         */
        function updateGauge(gauge, trend) {
            let rotation = 0; // Degrees from the start (left) of the arc
            let fillColorClass = '';
            let displayValue = trend.replace('_', ' ').toUpperCase();

            // Map trend to rotation and color class
            switch (trend) {
                case 'severely_decreased':
                    rotation = -45; // Further left
                    fillColorClass = 'color-severely_decreased';
                    break;
                case 'decreased':
                    rotation = -22.5; // Left of center
                    fillColorClass = 'color-decreased';
                    break;
                case 'normal':
                    rotation = 0; // Center
                    fillColorClass = 'color-normal';
                    break;
                case 'increased':
                    rotation = 22.5; // Right of center
                    fillColorClass = 'color-increased';
                    break;
                case 'zero':
                    rotation = -45; // Extreme left for zero
                    fillColorClass = 'color-zero';
                    displayValue = 'ZERO';
                    break;
                default:
                    rotation = 0;
                    fillColorClass = 'color-normal';
                    break;
            }

            gauge.needle.style.transform = `rotate(${rotation}deg)`;
            gauge.fill.className.baseVal = `gauge-fill ${fillColorClass}`; // Update fill color class
            gauge.valueText.textContent = displayValue;
        }


        /**
         * Analyzes the ECMO parameters (all qualitative trends)
         * and determines potential complications based on predefined patterns.
         * This is a simplified model for educational purposes.
         * @param {string} p1Trend - Trend of Pre-pump pressure.
         * @param {string} p2Trend - Trend of Post-pump pressure.
         * @param {string} p3Trend - Trend of Post-oxygenator pressure.
         * @param {string} deltaPTrend - Trend of Delta Pressure (P2-P3).
         * @param {string} flowTrend - Trend of Flow.
         * @param {string} rpmTrend - Trend of RPM.
         * @returns {string} - A description of the scenario and potential complications.
         */
        function analyzeECMOScenario(p1Trend, p2Trend, p3Trend, deltaPTrend, flowTrend, rpmTrend) {
            let complications = [];
            let analysisPoints = [];

            // General analysis based on individual trends
            if (p1Trend === 'severely_decreased') {
                analysisPoints.push("P1 is severely decreased (highly negative), indicating significant issues with venous return.");
                complications.push("Severe Access Insufficiency (e.g., patient hypovolemia, cannula malposition/kink, chattering, clot in access cannula).");
            } else if (p1Trend === 'decreased') {
                analysisPoints.push("P1 is decreased (negative or low), suggesting some difficulty with venous return.");
                complications.push("Moderate Access Insufficiency (e.g., hypovolemia, mild cannula malposition).");
            } else if (p1Trend === 'increased') {
                analysisPoints.push("P1 is increased, possibly due to increased systemic venous pressure or cannula obstruction.");
            }

            if (p2Trend === 'increased') {
                analysisPoints.push("P2 is increased, indicating high resistance after the pump, before the oxygenator.");
                complications.push("High Post-Pump Pressure (potential oxygenator clotting/failure, pre-oxygenator kink, or high resistance in return limb).");
            } else if (p2Trend === 'decreased') {
                analysisPoints.push("P2 is decreased, suggesting a severe leak, pump malfunction, or severe access issue leading to pump 'sucking air'.");
                complications.push("Low Post-Pump Pressure (possible severe leak, pump malfunction, or severe access issue leading to pump 'sucking air').");
            }

            if (p3Trend === 'increased') {
                analysisPoints.push("P3 is increased, indicating high resistance in the return line to the patient.");
                complications.push("High Return Pressure (return limb obstruction, cannula malposition, kinking, severe vasoconstriction, or clot in return cannula).");
            } else if (p3Trend === 'decreased') {
                analysisPoints.push("P3 is decreased, suggesting issues with blood returning to the patient.");
                complications.push("Low Return Pressure (return cannula dislodgement, severe vasodilation, or large air embolism in return, or circuit rupture).");
            }

            if (deltaPTrend === 'increased') {
                analysisPoints.push("Delta Pressure (P2-P3) is increased, indicating increased resistance across the oxygenator.");
                complications.push("Increased Oxygenator Resistance (strong indicator of oxygenator clotting or membrane failure).");
            } else if (deltaPTrend === 'decreased') {
                analysisPoints.push("Delta Pressure (P2-P3) is decreased, suggesting reduced resistance across the oxygenator or altered flow dynamics.");
                complications.push("Decreased Oxygenator Resistance (possible oxygenator bypass, circuit leak, or measurement error).");
            }

            if (flowTrend === 'zero') {
                analysisPoints.push("Flow is zero or near zero, indicating a critical flow stoppage.");
                complications.push("Critical Flow Stoppage (e.g., circuit rupture, severe air lock, complete pump failure, total access/return occlusion).");
            } else if (flowTrend === 'severely_decreased') {
                analysisPoints.push("Flow is critically low.");
                complications.push("Critically Low Flow (immediate investigation required for severe access issue, major clot, or pump failure).");
            } else if (flowTrend === 'decreased') {
                analysisPoints.push("Flow is decreased.");
                complications.push("Low Flow State (often due to access issues, oxygenator problems, or return obstruction).");
            }

            if (rpmTrend === 'increased') {
                analysisPoints.push("RPM is increased, suggesting the pump is working harder, potentially to compensate for low flow or increased resistance.");
                complications.push("Pump working harder, potentially to compensate for low flow or increased resistance.");
            } else if (rpmTrend === 'decreased') {
                analysisPoints.push("RPM is decreased, possibly due to deliberate adjustment or pump malfunction.");
                complications.push("Pump slowing down, possibly due to deliberate adjustment or pump malfunction.");
            } else if (rpmTrend === 'zero') {
                analysisPoints.push("RPM is zero, indicating the pump has stopped.");
                complications.push("Pump Stopped (e.g., power failure, pump malfunction, deliberate stop).");
            }

            // Specific Scenario Detection based on combined qualitative patterns
            // Note: The order of unshift matters for "Likely:" diagnoses
            // Power Failure
            if (rpmTrend === 'zero' && flowTrend === 'zero' && p2Trend === 'decreased' && p3Trend === 'decreased' && p1Trend === 'increased' && deltaPTrend === 'decreased') {
                complications.unshift("Likely: Power Failure to the ECMO pump.");
            }
            // Circuit Rupture / Disconnection
            if (flowTrend === 'zero' && rpmTrend === 'normal' && p2Trend === 'decreased' && p3Trend === 'decreased' && deltaPTrend === 'normal') { // Delta P normal because both P2/P3 drop similarly
                complications.unshift("Likely: Circuit Rupture / Disconnection (critical emergency).");
            }
            // Membrane Lung Clot / Oxygenator Failure
            if (deltaPTrend === 'increased' && flowTrend === 'decreased' && rpmTrend === 'normal') {
                complications.unshift("Likely: Oxygenator Clotting/Failure (high delta P across oxygenator).");
            }
            // Hypovolemia / Access Insufficiency (general)
            if ((p1Trend === 'decreased' || p1Trend === 'severely_decreased') && flowTrend === 'decreased' && rpmTrend === 'normal') {
                complications.unshift("Likely: Access Insufficiency (e.g., patient hypovolemia, cannula malposition/kink).");
            }
            // Clot in Access Cannula (more specific access issue)
            if (p1Trend === 'severely_decreased' && flowTrend === 'decreased' && rpmTrend === 'normal' && p2Trend === 'normal' && p3Trend === 'normal' && deltaPTrend === 'normal') {
                complications.unshift("Likely: Clot in Access Cannula.");
            }
            // Return Limb Obstruction (general)
            if (p3Trend === 'increased' && flowTrend === 'decreased' && rpmTrend === 'normal') {
                complications.unshift("Likely: Return Limb Obstruction (e.g., cannula kink, patient vasoconstriction).");
            }
            // Clot in Return Cannula (more specific return issue)
            if (p3Trend === 'increased' && p2Trend === 'increased' && flowTrend === 'decreased' && rpmTrend === 'normal' && deltaPTrend === 'normal') { // Delta P normal if both increase proportionally
                complications.unshift("Likely: Clot in Return Cannula.");
            }
            // Air in Access Circuit (often causes P1 to swing wildly, leading to 'severely_decreased' and very low flow)
            if (p1Trend === 'severely_decreased' && flowTrend === 'severely_decreased' && rpmTrend === 'normal' && p2Trend === 'decreased' && p3Trend === 'decreased' && deltaPTrend === 'normal') {
                complications.unshift("Likely: Severe Access Chattering / Air in Circuit (requires immediate attention).");
            }
            // Impending Pump Failure
            if (flowTrend === 'decreased' && rpmTrend === 'normal' && p2Trend === 'decreased' && p3Trend === 'decreased' && p1Trend === 'normal' && deltaPTrend === 'normal') {
                complications.unshift("Possible: Impending Pump Failure or significant circuit leak.");
            }


            // Construct the final message
            let resultMessage = "<strong>Current Parameter Trends:</strong><br>";
            resultMessage += `P1 (Pre-pump): <strong>${p1Trend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += `P2 (Post-pump): <strong>${p2Trend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += `P3 (Post-oxygenator): <strong>${p3Trend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += `Delta Pressure (P2-P3): <strong>${deltaPTrend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += `Flow: <strong>${flowTrend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += `RPM: <strong>${rpmTrend.replace('_', ' ').toUpperCase()}</strong><br>`;
            resultMessage += "<br>";

            resultMessage += "<strong>Scenario Analysis:</strong><br>";
            if (analysisPoints.length > 0) {
                resultMessage += analysisPoints.join("<br>") + "<br><br>";
            } else {
                resultMessage += "Parameters appear within typical ranges, or no specific major deviation identified by this simplified model.<br><br>";
            }

            resultMessage += "<strong>Potential Complications:</strong><br>";
            if (complications.length > 0) {
                const uniqueComplications = [...new Set(complications)];
                resultMessage += uniqueComplications.map(c => `- ${c}`).join("<br>");
            } else {
                resultMessage += "No immediate major complications identified based on the provided parameters. Always monitor patient clinical status and other parameters closely.";
            }

            return resultMessage;
        }

        // --- Simulator Specific Logic ---
        scenarioSelect.addEventListener('change', (event) => {
            const selectedScenarioKey = event.target.value;
            const scenario = scenarios[selectedScenarioKey];

            // Get references to the individual parameter select elements
            const p1Select = gauges.p1.select;
            const p2Select = gauges.p2.select;
            const p3Select = gauges.p3.select;
            const deltaPSelect = gauges.deltaP.select;
            const flowSelect = gauges.flow.select;
            const rpmSelect = gauges.rpm.select;

            // Function to update display and analysis based on current dropdown values
            const updateSimulatorDisplayAndAnalysis = () => {
                const currentP1Trend = p1Select.value;
                const currentP2Trend = p2Select.value;
                const currentP3Trend = p3Select.value;
                const currentDeltaPTrend = deltaPSelect.value;
                const currentFlowTrend = flowSelect.value;
                const currentRpmTrend = rpmSelect.value;

                // Update gauge visuals based on current dropdown values
                updateGauge(gauges.p1, currentP1Trend);
                updateGauge(gauges.p2, currentP2Trend);
                updateGauge(gauges.p3, currentP3Trend);
                updateGauge(gauges.deltaP, currentDeltaPTrend);
                updateGauge(gauges.flow, currentFlowTrend);
                updateGauge(gauges.rpm, currentRpmTrend);

                // Generate and display the scenario information
                let displayContent = `
                    <p class="scenario-name">${scenario.name} <span class="scenario-graphic">${scenario.graphic}</span></p>
                    <p class="scenario-description" id="shortDescription">${scenario.shortDescription}</p>
                    <p class="scenario-description full-description" id="fullDescription">${scenario.fullDescription}</p>
                    <button class="read-more-btn" id="readMoreBtn">Read More</button>
                    <hr class="my-4">
                `;

                // Add the detailed analysis from analyzeECMOScenario
                displayContent += analyzeECMOScenario(
                    currentP1Trend,
                    currentP2Trend,
                    currentP3Trend,
                    currentDeltaPTrend,
                    currentFlowTrend,
                    currentRpmTrend
                );

                resultsDiv.innerHTML = displayContent;

                // Re-attach event listener for the new Read More button (as innerHTML replaces it)
                const readMoreBtn = document.getElementById('readMoreBtn');
                const shortDesc = document.getElementById('shortDescription');
                const fullDesc = document.getElementById('fullDescription');

                // Append algorithm if it exists for the scenario
                if (scenario.algorithm) {
                    fullDesc.innerHTML += scenario.algorithm;
                }

                if (readMoreBtn) {
                    const hasMoreContent = scenario.fullDescription.length > scenario.shortDescription.length || scenario.algorithm !== null;

                    if (hasMoreContent) {
                        readMoreBtn.style.display = 'block';
                        fullDesc.style.display = 'none';
                        shortDesc.style.display = 'block';
                    } else {
                        readMoreBtn.style.display = 'none';
                        fullDesc.style.display = 'block';
                        shortDesc.style.display = 'none';
                    }

                    readMoreBtn.addEventListener('click', () => {
                        if (fullDesc.style.display === 'none') {
                            fullDesc.style.display = 'block';
                            shortDesc.style.display = 'none';
                            readMoreBtn.textContent = 'Show Less';
                        } else {
                            fullDesc.style.display = 'none';
                            shortDesc.style.display = 'block';
                            readMoreBtn.textContent = 'Read More';
                        }
                    });
                }
            }; // End of updateSimulatorDisplayAndAnalysis function

            // Set dropdown values and enable/disable them
            p1Select.value = scenario.params.p1;
            p2Select.value = scenario.params.p2;
            p3Select.value = scenario.params.p3;
            deltaPSelect.value = scenario.params.deltaP;
            flowSelect.value = scenario.params.flow;
            rpmSelect.value = scenario.params.rpm;

            const isCustom = selectedScenarioKey === 'custom';
            for (const key in gauges) {
                if (gauges[key].select) { // Ensure the select element exists
                    gauges[key].select.disabled = !isCustom;
                    // Remove existing listeners to prevent multiple calls
                    gauges[key].select.removeEventListener('change', updateSimulatorDisplayAndAnalysis);
                    if (isCustom) {
                        // Add listener only if in custom mode
                        gauges[key].select.addEventListener('change', updateSimulatorDisplayAndAnalysis);
                    }
                }
            }

            // Perform initial update for the selected scenario (or custom defaults)
            updateSimulatorDisplayAndAnalysis();
        });

        // --- Quiz Logic ---
        const quizGaugesMap = {
            p1: quizGauges.p1, p2: quizGauges.p2, p3: quizGauges.p3,
            deltaP: quizGauges.deltaP, flow: quizGauges.flow, rpm: quizGauges.rpm
        };

        function displayQuizQuestion() {
            const question = quizQuestions[currentQuizQuestionIndex];
            questionCounter.textContent = `Question ${currentQuizQuestionIndex + 1} of ${quizQuestions.length}`;
            quizVignette.textContent = question.vignette;

            // Update quiz gauges
            updateGauge(quizGaugesMap.p1, question.params.p1);
            updateGauge(quizGaugesMap.p2, question.params.p2);
            updateGauge(quizGaugesMap.p3, question.params.p3);
            updateGauge(quizGaugesMap.deltaP, question.params.deltaP);
            updateGauge(quizGaugesMap.flow, question.params.flow);
            updateGauge(quizGaugesMap.rpm, question.params.rpm);

            // Clear previous options and feedback
            quizOptionsDiv.innerHTML = '';
            quizFeedbackDiv.style.display = 'none';
            quizFeedbackDiv.className = 'mt-4'; // Reset classes

            // Create options
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'quiz-option-btn';
                button.onclick = () => selectQuizOption(index);
                quizOptionsDiv.appendChild(button);
            });

            // Update navigation buttons
            quizPrevBtn.disabled = currentQuizQuestionIndex === 0;
            quizNextBtn.disabled = userQuizAnswers[currentQuizQuestionIndex] === undefined && currentQuizQuestionIndex < quizQuestions.length - 1;

            // Restore user's previous answer if exists
            if (userQuizAnswers[currentQuizQuestionIndex] !== undefined) {
                const selectedOptionBtn = quizOptionsDiv.children[userQuizAnswers[currentQuizQuestionIndex].selectedOptionIndex];
                if (selectedOptionBtn) {
                    selectedOptionBtn.classList.add('selected');
                    if (userQuizAnswers[currentQuizQuestionIndex].isCorrect) {
                        selectedOptionBtn.classList.add('correct');
                        quizFeedbackDiv.textContent = "Correct! " + question.explanation;
                        quizFeedbackDiv.classList.add('correct-feedback');
                    } else {
                        selectedOptionBtn.classList.add('incorrect');
                        quizFeedbackDiv.textContent = "Incorrect. " + question.explanation;
                        quizFeedbackDiv.classList.add('incorrect-feedback');
                    }
                    quizFeedbackDiv.style.display = 'block';
                    disableQuizOptions();
                }
            }
            updateQuizScoreDisplay();
        }

        function selectQuizOption(selectedIndex) {
            const question = quizQuestions[currentQuizQuestionIndex];
            const isCorrect = (selectedIndex === question.correctAnswerIndex);
            const scoreEarned = isCorrect ? 5 : 0;

            // Store answer
            userQuizAnswers[currentQuizQuestionIndex] = {
                selectedOptionIndex: selectedIndex,
                isCorrect: isCorrect,
                score: scoreEarned
            };

            // Update UI
            Array.from(quizOptionsDiv.children).forEach((button, index) => {
                button.classList.remove('selected');
                if (index === selectedIndex) {
                    button.classList.add('selected');
                    if (isCorrect) {
                        button.classList.add('correct');
                    } else {
                        button.classList.add('incorrect');
                    }
                }
                // Highlight correct answer if incorrect was chosen
                if (!isCorrect && index === question.correctAnswerIndex) {
                    button.classList.add('correct');
                }
            });

            quizFeedbackDiv.textContent = (isCorrect ? "Correct! " : "Incorrect. ") + question.explanation;
            quizFeedbackDiv.className = `mt-4 ${isCorrect ? 'correct-feedback' : 'incorrect-feedback'}`;
            quizFeedbackDiv.style.display = 'block';

            disableQuizOptions();
            updateQuizScoreDisplay();
            quizNextBtn.disabled = false; // Enable next button after answering
        }

        function disableQuizOptions() {
            Array.from(quizOptionsDiv.children).forEach(button => {
                button.disabled = true;
                button.style.pointerEvents = 'none';
            });
        }

        function updateQuizScoreDisplay() {
            quizScore = userQuizAnswers.reduce((total, answer) => total + (answer ? answer.score : 0), 0);
            quizScoreDisplay.textContent = `Score: ${quizScore} / 50`;

            if (currentQuizQuestionIndex === quizQuestions.length - 1 && userQuizAnswers[currentQuizQuestionIndex] !== undefined) {
                // All questions answered, show final score
                quizNextBtn.textContent = "Finish Quiz";
            } else {
                quizNextBtn.textContent = "Next";
            }
        }

        quizNextBtn.addEventListener('click', () => {
            if (currentQuizQuestionIndex < quizQuestions.length - 1) {
                currentQuizQuestionIndex++;
                displayQuizQuestion();
            } else if (currentQuizQuestionIndex === quizQuestions.length - 1 && userQuizAnswers[currentQuizQuestionIndex] !== undefined) {
                // Quiz finished, show final score summary (optional, could be a modal)
                alert(`Quiz Finished! Your total score is: ${quizScore} / 50`);
                // Optionally, reset quiz or show a summary screen
            }
        });

        quizPrevBtn.addEventListener('click', () => {
            if (currentQuizQuestionIndex > 0) {
                currentQuizQuestionIndex--;
                displayQuizQuestion();
            }
        });

        startQuizBtn.addEventListener('click', () => {
            mainSimulatorSection.style.display = 'none';
            quizSection.style.display = 'flex';
            currentQuizQuestionIndex = 0;
            quizScore = 0;
            userQuizAnswers = []; // Reset answers for new quiz session
            displayQuizQuestion();
            updateQuizScoreDisplay();
        });

        backToSimulatorBtn.addEventListener('click', () => {
            quizSection.style.display = 'none';
            mainSimulatorSection.style.display = 'flex';
            // Reset simulator to normal operation when returning
            scenarioSelect.value = "normal_operation";
            scenarioSelect.dispatchEvent(new Event('change'));
        });


        // --- Initial Load ---
        window.onload = function() {
            // Set default simulator scenario to "Normal Operation" and trigger change event
            scenarioSelect.value = "normal_operation";
            scenarioSelect.dispatchEvent(new Event('change'));
        };
    </script>
</body>
</html>
